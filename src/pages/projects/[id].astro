---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectPreview from '../../components/ProjectPreview.astro';
import PublicationCard from '../../components/PublicationCard.astro';
import PresentationCard from '../../components/PresentationCard.astro';
import ReferenceButtons from '../../components/ReferenceButtons.astro';
import { sortItemsByDateDesc } from '../../utils/data-utils';

export async function getStaticPaths() {
  const projects = (await getCollection('projects')).sort(sortItemsByDateDesc);
  const projectCount = projects.length;
  return projects.map((project, index) => ({
    params: { id: project.id },
    props: {
      project,
      prevProject: index + 1 !== projectCount ? projects[index + 1] : null,
      nextProject: index !== 0 ? projects[index - 1] : null,
    },
  }));
}

type Props = {
  project: CollectionEntry<'projects'>;
  prevProject: CollectionEntry<'projects'>;
  nextProject: CollectionEntry<'projects'>;
};

const { project, prevProject, nextProject } = Astro.props;
const {
  title,
  timeperiod,
  company,
  description,
  publications,
  relevantPublications,
  presentations,
  references,
  headerImage,
  seo,
} = project.data;
const { Content } = await render(project);

// Handle both string and object formats for headerImage
const lightImage =
  typeof headerImage === 'object' ? headerImage.light : headerImage;
const darkImage =
  typeof headerImage === 'object' ? headerImage.dark : headerImage;
const imageAlt = typeof headerImage === 'object' ? headerImage.alt : title;
const imageCaption =
  typeof headerImage === 'object' ? headerImage.caption : undefined;
const imageLongDescription =
  typeof headerImage === 'object' ? headerImage.longDescription : undefined;
---

<BaseLayout
  title={seo?.title ?? title}
  description={seo?.description ?? description}
  image={seo?.image}
  pageType="article"
  showHeader={false}
>
  <div class="mb-16 sm:mb-24 lg:max-w-5xl max-w-full mx-auto py-8 sm:py-10">
    <header class="mb-8 sm:mb-10">
      <h1
        class="text-3xl sm:text-4xl lg:text-5xl leading-tight font-sans font-semibold mb-3"
      >
        {title}
      </h1>
      <div class="text-lg sm:text-xl lg:text-2xl leading-relaxed">
        <span class="font-medium">{company}</span>
        {timeperiod && <span class="opacity-80"> | {timeperiod}</span>}
      </div>
    </header>
    {
      (lightImage || darkImage) && (
        <figure class="mb-8 sm:mb-10">
          {lightImage && (
            <img
              src={lightImage.replace('public/', '/')}
              alt={imageAlt || title}
              aria-label={imageAlt || title}
              aria-describedby={imageLongDescription ? 'figure-long-desc' : undefined}
              class="w-full max-w-2xl mx-auto rounded-lg block dark:hidden"
            />
          )}
          {darkImage && (
            <img
              src={darkImage.replace('public/', '/')}
              alt={imageAlt || title}
              aria-label={imageAlt || title}
              aria-describedby={imageLongDescription ? 'figure-long-desc' : undefined}
              class="w-full max-w-2xl mx-auto rounded-lg hidden dark:block"
            />
          )}
          {imageCaption && (
            <figcaption class="mt-3 text-sm md:text-md lg:text-lg sm:text-base text-center text-main/70 italic max-w-2xl mx-auto" set:html={imageCaption} />
          )}
          {imageLongDescription && (
            <details class="mt-4 max-w-2xl mx-auto">
              <summary class="cursor-pointer text-sm sm:text-base text-accent hover:text-accent/80 font-medium transition-colors">
                View text description of flowchart
              </summary>
              <div id="figure-long-desc" class="mt-3 text-sm sm:text-base text-main/80 prose prose-sm sm:prose-base prose-headings:text-main prose-p:text-main prose-li:text-main prose-ol:text-main max-w-none" set:html={imageLongDescription} />
            </details>
          )}
        </figure>
      )
    }
    <div
      id="markdown-content"
      class="max-w-none prose prose-lg sm:prose-xl lg:prose-2xl prose-headings:font-sans prose-headings:font-semibold prose-headings:text-main dark:prose-headings:text-white prose-h2:text-3xl prose-h2:sm:text-4xl prose-h2:leading-tight prose-p:text-main prose-p:text-lg sm:prose-p:text-xl prose-p:leading-relaxed prose-a:text-main prose-strong:text-main prose-code:text-main prose-li:text-main prose-ul:text-main prose-ol:text-main"
    >
      <Content />
    </div>

    <script>
      document.addEventListener('astro:page-load', () => {
        const content = document.getElementById('markdown-content');
        if (!content) return;

        // Find all H2 elements
        const h2Elements = content.querySelectorAll('h2');

        h2Elements.forEach((h2) => {
          // Create details element
          const details = document.createElement('details');
          details.open = true; // Expanded by default
          details.className = 'group';

          // Create summary element
          const summary = document.createElement('summary');
          summary.className = 'cursor-pointer text-3xl sm:text-4xl leading-tight font-sans font-semibold mb-6 hover:text-accent transition-colors flex items-center gap-3 text-main dark:text-white';

          // Create span for heading text
          const span = document.createElement('span');
          span.textContent = h2.textContent;

          // Create chevron SVG
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('class', 'w-6 h-6 transition-transform group-open:rotate-180');
          svg.setAttribute('fill', 'none');
          svg.setAttribute('stroke', 'currentColor');
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('aria-hidden', 'true');

          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          path.setAttribute('stroke-linecap', 'round');
          path.setAttribute('stroke-linejoin', 'round');
          path.setAttribute('stroke-width', '2');
          path.setAttribute('d', 'M19 9l-7 7-7-7');

          svg.appendChild(path);
          summary.appendChild(span);
          summary.appendChild(svg);

          // Create div for content
          const contentDiv = document.createElement('div');

          // Collect all siblings until next H2
          let sibling = h2.nextElementSibling;
          while (sibling && sibling.tagName !== 'H2') {
            const next = sibling.nextElementSibling;
            contentDiv.appendChild(sibling);
            sibling = next;
          }

          // Replace H2 with details
          details.appendChild(summary);
          details.appendChild(contentDiv);
          h2.replaceWith(details);
        });
      });
    </script>
    {
      publications && publications.length > 0 && (
        <div class="mt-12 sm:mt-16">
          <details class="group" open>
            <summary class="cursor-pointer text-3xl sm:text-4xl leading-tight font-sans font-semibold mb-6 hover:text-accent transition-colors flex items-center gap-3">
              <span>Publications</span>
              <svg
                class="w-6 h-6 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>
            <div class="space-y-6 mt-6">
              {publications.map((pub) => (
                <PublicationCard publication={pub} />
              ))}
            </div>
          </details>
        </div>
      )
    }
    {
      relevantPublications && relevantPublications.length > 0 && (
        <div class="mt-12 sm:mt-16">
          <details class="group" open>
            <summary class="cursor-pointer text-3xl sm:text-4xl leading-tight font-sans font-semibold mb-6 hover:text-accent transition-colors flex items-center gap-3">
              <span>Relevant Publications</span>
              <svg
                class="w-6 h-6 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>
            <div class="space-y-6 mt-6">
              {relevantPublications.map((pub) => (
                <PublicationCard publication={pub} />
              ))}
            </div>
          </details>
        </div>
      )
    }
    {
      presentations && presentations.length > 0 && (
        <div class="mt-12 sm:mt-16">
          <details class="group" open>
            <summary class="cursor-pointer text-3xl sm:text-4xl leading-tight font-sans font-semibold mb-6 hover:text-accent transition-colors flex items-center gap-3">
              <span>Presentations</span>
              <svg
                class="w-6 h-6 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>
            <div class="space-y-4 mt-6">
              {presentations.map((pres) => (
                <PresentationCard presentation={pres} />
              ))}
            </div>
          </details>
        </div>
      )
    }
    {
      references && references.length > 0 && (
        <div class="mt-12 sm:mt-16">
          <details class="group" open>
            <summary class="cursor-pointer text-3xl sm:text-4xl leading-tight font-sans font-semibold mb-6 hover:text-accent transition-colors flex items-center gap-3">
              <span>References</span>
              <svg
                class="w-6 h-6 transition-transform group-open:rotate-180"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </summary>
            <div class="mt-6">
              <ReferenceButtons references={references} />
            </div>
          </details>
        </div>
      )
    }
    {
      (prevProject || nextProject) && (
        <div class="mt-16 sm:mt-24 pt-12 sm:pt-16 border-t-2 border-main">
          <div class="mb-16 sm:mb-24">
            <h2 class="mb-8 text-3xl leading-tight font-sans font-semibold sm:mb-10 sm:text-4xl">
              More Work Experiences
            </h2>
            {nextProject && (
              <ProjectPreview
                project={nextProject}
                class="mb-6 sm:mb-8"
                headingLevel="h3"
              />
            )}
            {prevProject && (
              <ProjectPreview
                project={prevProject}
                class="mb-6 sm:mb-8"
                headingLevel="h3"
              />
            )}
          </div>
        </div>
      )
    }
  </div>
</BaseLayout>
