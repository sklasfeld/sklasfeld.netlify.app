---
import type { GetStaticPathsOptions } from 'astro';
import { type CollectionEntry, getCollection } from 'astro:content';
import Pagination from '../../components/Pagination.astro';
import PostPreview from '../../components/PostPreview.astro';
import SeriesPreview from '../../components/SeriesPreview.astro';
import Subscribe from '../../components/Subscribe.astro';
import siteConfig from '../../data/site-config';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllSeries } from '../../utils/data-utils';

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const allPosts = (await getCollection('blog'))
    .filter((post) => !post.data.draft)
    .filter((post) => post.data.publishDate <= new Date());

  // Standalone posts (not in a series)
  const standalonePosts = allPosts.filter((post) => !post.data.series);

  // Get all series
  const seriesList = getAllSeries(allPosts);

  // Build a mixed list: standalone posts + series entries, sorted by date
  type BlogItem =
    | { type: 'post'; post: CollectionEntry<'blog'>; date: Date }
    | { type: 'series'; series: typeof seriesList[number]; date: Date };

  const items: BlogItem[] = [
    ...standalonePosts.map((post) => ({
      type: 'post' as const,
      post,
      date: new Date(post.data.publishDate),
    })),
    ...seriesList.map((series) => ({
      type: 'series' as const,
      series,
      date: series.latestDate,
    })),
  ].sort((a, b) => b.date.getTime() - a.date.getTime());

  return paginate(items, { pageSize: siteConfig.postsPerPage || 4 });
}

const { page } = Astro.props;
const items = page.data;
---

<BaseLayout
  title="Blog"
  description="Embark on a journey of personal insights and experiences through my blog"
  showHeader={false}
>
  <div class="lg:max-w-5xl max-w-full mx-auto py-8 sm:py-10">
    <h1
      class="text-4xl sm:text-5xl lg:text-6xl font-sans font-semibold mb-8 sm:mb-10"
    >
      Blog Archive
    </h1>
    {items.map((item) =>
      item.type === 'series' ? (
        <SeriesPreview series={item.series} class="mb-10 sm:mb-12" />
      ) : (
        <PostPreview post={item.post} class="mb-10 sm:mb-12" />
      )
    )}
    <Pagination page={page} class="my-16 sm:my-24" />
    <Subscribe class="my-16 sm:my-24" />
  </div>
</BaseLayout>
