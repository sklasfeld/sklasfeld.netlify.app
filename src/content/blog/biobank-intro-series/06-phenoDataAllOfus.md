---
title: 'Biobank Intro Series: All of Us Observational Data (Part II)'
excerpt: 'Loading observational data in the All of Us Researcher Workbench'
publishDate: 'Mar 31 2026'
tags:
  - biobank
  - all-of-us
  - omop
  - athena
  - ehr-data
  - observational-data
draft: false
series:
  name: 'Biobank Intro Series'
  order: 6
seo:
  image:
    src: '/blog_images/biobank1/aou_observation_dataset_tools.png'
    alt: 'Three illustrated scenes representing All of Us data tools: a meal kit for Cohort and Dataset Builders, a stocked pantry for OMOP SQL access, and a vegetable garden for CDR directory files.'
---

<figure class="my-8 !max-w-none">
<img src="/blog_images/biobank1/aou_observation_dataset_tools.png" alt="Three illustrated scenes representing All of Us data tools: a meal kit for Cohort and Dataset Builders, a stocked pantry for OMOP SQL access, and a vegetable garden for CDR directory files." class="!max-w-none mx-auto w-full" >
<figcaption class="text-center text-sm opacity-80 mt-2">
   <em>Tools for building datasets in All of Us. Cohort and dataset builders are easy-to-use tools but they are limited similar to a meal kit box. OMOP CDM SQL queries are flexible but more complex, like cooking from a fully stocked pantry. The CDR and other external data sources expand available data but are separate, like ingredients from an accessible garden. Images generated by ChatGPT.</em>
 </figcaption>
</figure>

Continuing from [Part I](../05-aou-omop), you know how to find OMOP concept IDs. Now let's look at how to actually pull data in the All of Us (AoU) Researcher Workbench. Not everything lives in SQL tables, and not everything requires writing SQL.

## Beyond SQL: CDR Directory Files

If you have access to the [Controlled CDR directory](https://support.researchallofus.org/hc/en-us/articles/29475233432212-Controlled-CDR-Directory), you'll find pre-computed genomic data (e.g., precomputed genetic ancestry, admixture estimates, relatedness, etc.) stored outside the OMOP tables entirely. These genetically-derived estimates can complement or replace the self-reported race and ethnicity values in the BigQuery tables.

## Cohort and Dataset Builders

Before writing any SQL, it's worth trying the AoU [Cohort and Dataset Builders](https://www.researchallofus.org/data-tools/workbench/). These point-and-click tools work in two steps: define your participant criteria (the Cohort Builder), then build your data features (the Dataset Builder). If this gives you everything you need then that is awesome. I did not find that to be the case, but I found them useful for exploration and seeing what's available without dealing with OMOP codes directly. A hack click "Analyze" â†’ "See Code Preview" to see the underlying BigQuery SQL.

## Querying OMOP Tables

<figure class="my-8 !max-w-none">
<img src="/blog_images/biobank1/omop_table_relationships.png" alt="Diagram showing OMOP table relationships. Person table at the top connects via person_id joins to four clinical tables: condition occurrence, measurement, drug exposure, and observation. Concept table at the bottom connects via concept ID lookups to all five tables, translating coded values into readable labels." style="max-height: 600px; width: auto;" />
<figcaption class="text-center text-sm opacity-80 mt-2">
   <em>Relationships between key OMOP table to generate a cohort of participants with relevant data features. The `person` table links to clinical tables through `person_id`, while the `concept` table uses `concept_id` to translate coded values across all tables.</em>
 </figcaption>
</figure>

If the builders aren't enough, it's time for SQL. The full [OMOP CDM schema](https://ohdsi.github.io/CommonDataModel/cdm53.html) shas dozens of tables, but most AoU analyses revolve around a handful:

- `person`: demographics for each participant
- `condition_occurrence`: dates of the beginning of specific disease or medical conditions as observed by a provider or reported by a patient
- `measurement`: lab values and test results (e.g., BMI, blood pressure)
- `observation`: clinical facts gathered during a participant examination, questioning or a procedure that cannot be measured with a standardized test such as medical history, family history, and lifestyle choices.
- `drug_exposure`: medication records, useful for validating diagnoses or predicting undiagnosed conditions

All code below assumes the following setup:

```{python}
import pandas as pd
import os
CDR = os.environ['WORKSPACE_CDR']
```

### The `person` Table

The person table is the starting point. There is one row per participant. Demographic fields like gender are stored three ways: gender_concept_id, gender_source_value, and gender_source_concept_id. The source value contains the raw data from each contributing site, which can be inconsistent ("Female", "F", "female"). To get standardized labels, join to the concept table:

```{python}
gender_query = f'''
  SELECT
    person.person_id,
    p_gender_concept.concept_name as gender
  FROM `{CDR}.person` person
  LEFT JOIN
    `{CDR}.concept` p_gender_concept
    ON person.gender_concept_id = p_gender_concept.concept_id
'''
gender_df = pd.io.gbq.read_gbq(gender_query, dialect='standard')
```

This JOIN pattern of linking a concept ID column to `concept.concept_id` to get `concept_name` repeats throughout OMOP. It works the same way for race, ethnicity, and any other coded field.

### The `condition_occurrence` Table

This table is useful for identifying cases and controls. For example, to find all participants diagnosed with Alzheimer's disease (concept ID 378419) and their earliest diagnosis date:

```{python}
az_query = f'''
  SELECT
    person_id,
    MIN(condition_start_date) AS dx_date_az
  FROM `{CDR}.condition_occurrence`
  WHERE condition_concept_id = 378419
  GROUP BY person_id
'''
az_df = pd.io.gbq.read_gbq(az_query, dialect='standard')
```

This returns only participants with the diagnosis. To turn it into a case/control flag, merge it with a table that has all participants.

### Putting it all together

Each query above produces its own dataframe. To build a cohort table, merge them:

```{python}
az_df['has_az'] = True

full_df = pd.merge(
  gender_df,
  az_df,
  on='person_id',
  how='left'
)
```

After the left join, participants with an Alzheimer's diagnosis will have `has_az = True` and a diagnosis date, while everyone else will have null values. You can fill the null values with `full_df['has_az'] = full_df['has_az'].fillna(False)` for a clean boolean column. This gives you a case/control column without needing a separate query for controls. Add more condition, measurement, or drug exposure queries and merge them the same way.

This pattern scales to any study: find your concept IDs ([Part I](../05-aou-omop)), query the relevant OMOP tables, join to `concept` for readable labels, and merge the resulting dataframes in pandas.
